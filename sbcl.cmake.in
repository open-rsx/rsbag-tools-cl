SET(ENV{CC} @CMAKE_C_COMPILER@)
SET(ENV{SBCL_HOME} "@SBCL_HOME@")
SET(ENV{CL_SOURCE_REGISTRY} "@CL_SOURCE_REGISTRY@")
SET(ENV{ASDF_OUTPUT_TRANSLATIONS} "@ASDF_OUTPUT_TRANSLATIONS@")

# Dump image.
MESSAGE("Dumping image file @NAME@")
EXECUTE_PROCESS(COMMAND           "@SBCL_EXECUTABLE@"
                                  --disable-debugger
				  --no-sysinit
				  @LISP_INIT@
				  --load "@CMAKE_CURRENT_SOURCE_DIR@/sbclrc"
				  --load "@SCRIPT@"
                WORKING_DIRECTORY "@CMAKE_CURRENT_BINARY_DIR@"
                OUTPUT_FILE       "@CMAKE_CURRENT_BINARY_DIR@/@NAME@.log"
		RESULT_VARIABLE   RESULT)
IF(NOT ${RESULT} EQUAL 0)
    MESSAGE(FATAL_ERROR "Failed to dump image file @NAME@")
ENDIF()

# Compress image.
IF(EXISTS "@GZEXE_EXECUTABLE@")
    MESSAGE("Compressing image file @NAME@")
    EXECUTE_PROCESS(COMMAND     "@GZEXE_EXECUTABLE@" "@CMAKE_CURRENT_BINARY_DIR@/@NAME@"
                    OUTPUT_FILE "@CMAKE_CURRENT_BINARY_DIR@/@NAME@.gzexe.log")
    FILE(REMOVE "@CMAKE_CURRENT_BINARY_DIR@/@NAME@~")
ENDIF()
